<div class="transactions-container">
  <header class="page-header">
    <h1>Transactions</h1>
  </header>

  <div class="transactions-layout">
    <!-- Quick Add Form -->
    <aside class="form-section">
      <div class="app-card sticky-form">
        <div class="section-header">
          <h2>{{ editingEventId() ? 'Edit Transaction' : 'Quick Add' }}</h2>
        </div>

        <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()">
          <!-- Amount Section -->
          <div class="form-group amount-group">
            <mat-form-field appearance="outline" class="amount-field">
              <mat-label>Amount</mat-label>
              <input matInput type="number" formControlName="amount" placeholder="0.00" required>
              <span matTextPrefix>$&nbsp;</span>
              @if (transactionForm.get('amount')?.hasError('required') && transactionForm.get('amount')?.touched) {
                <mat-error>Required</mat-error>
              }
              @if (transactionForm.get('amount')?.hasError('max')) {
                <mat-error>Too large</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Date</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="date" required>
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>
          </div>

          <!-- Type Selection -->
          <div class="form-group">
            <label class="form-label">Transaction Type</label>
            <mat-button-toggle-group formControlName="type" class="type-toggle-grid">
              @for (type of eventTypes; track type.value) {
                <mat-button-toggle [value]="type.value" [title]="type.label">
                  <mat-icon>{{ type.icon }}</mat-icon>
                  <span class="toggle-label">{{ type.label }}</span>
                </mat-button-toggle>
              }
            </mat-button-toggle-group>
          </div>

          <!-- Account Selection -->
          <div class="form-group">
            @if (transactionForm.get('type')?.value !== 'DebtCharge') {
              <mat-form-field appearance="outline">
                <mat-label>From Account</mat-label>
                <mat-select formControlName="accountId" required>
                  @for (account of cashAccounts(); track account.id) {
                    <mat-option [value]="account.id">{{ account.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            }

            @if (showTargetAccount() || transactionForm.get('type')?.value === 'DebtCharge') {
              <mat-form-field appearance="outline">
                <mat-label>{{ transactionForm.get('type')?.value === 'DebtCharge' ? 'Debt Account' : 'To Account' }}</mat-label>
                <mat-select formControlName="targetAccountId" required>
                  @for (account of filteredTargetAccounts(); track account.id) {
                    <mat-option [value]="account.id">{{ account.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            }
          </div>

          <!-- Description -->
          <mat-form-field appearance="outline">
            <mat-label>Description / Notes</mat-label>
            <input matInput formControlName="description" placeholder="e.g., Grocery shopping">
          </mat-form-field>

          <div class="form-actions">
            <button mat-button type="button" (click)="resetForm()">
              {{ editingEventId() ? 'Cancel' : 'Clear' }}
            </button>
            <button mat-flat-button color="primary" type="submit" [disabled]="!transactionForm.valid || saving()">
              {{ editingEventId() ? 'Update' : 'Save Transaction' }}
            </button>
          </div>
        </form>
      </div>
    </aside>

    <!-- Main Content Area: Recent Transactions -->
    <main class="list-section">
      <div class="app-card">
        <div class="section-header">
          <div class="header-main">
            <h2>Recent Activity</h2>
            @if (pendingCount() > 0) {
              <span class="pending-count">{{ pendingCount() }} pending</span>
            }
          </div>
          
          <div class="filter-controls">
            <mat-button-toggle-group [value]="statusFilter()" (change)="setStatusFilter($event.value)" class="segmented-control">
              <mat-button-toggle value="All">All</mat-button-toggle>
              <mat-button-toggle value="Pending">Pending</mat-button-toggle>
              <mat-button-toggle value="Cleared">Cleared</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        @if (loading()) {
          <div class="skeleton-list" aria-busy="true">
            @for (i of [1,2,3,4,5]; track i) {
              <div class="skeleton-row"></div>
            }
          </div>
        } @else if (filteredEvents().length === 0) {
          <div class="empty-state">
            <mat-icon>receipt_long</mat-icon>
            <p>No transactions found for the selected filter.</p>
          </div>
        } @else {
          <div class="transaction-list">
            @for (event of filteredEvents(); track event.id) {
              <div class="transaction-row">
                <div class="transaction-icon" [class]="event.type.toLowerCase()">
                  <mat-icon>{{ getEventIcon(event.type) }}</mat-icon>
                </div>
                
                <div class="transaction-info">
                  <span class="description">{{ event.description || event.type }}</span>
                  <span class="account">
                    {{ getAccountName(event.accountId) }}
                    @if (event.targetAccountId) {
                      <mat-icon class="arrow">arrow_forward</mat-icon>
                      {{ getAccountName(event.targetAccountId) }}
                    }
                  </span>
                </div>

                <div class="transaction-meta">
                  <span class="date">{{ formatDisplayDate(event.date) }}</span>
                  <button class="status-chip" [class]="event.status.toLowerCase()" (click)="toggleStatus(event)" [title]="'Mark as ' + (event.status === 'Pending' ? 'Cleared' : 'Pending')">
                    <mat-icon>{{ event.status === 'Cleared' ? 'check_circle' : 'pending' }}</mat-icon>
                    {{ event.status }}
                  </button>
                </div>

                <div class="transaction-amount" [class.income]="isIncome(event.type)" [class.expense]="isExpense(event.type)">
                  {{ isIncome(event.type) ? '+' : '-' }}{{ formatCurrency(event.amount) }}
                </div>

                <div class="transaction-actions">
                  <button mat-icon-button (click)="editEvent(event)" aria-label="Edit">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button (click)="deleteEvent(event)" aria-label="Delete">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </main>
  </div>
</div>