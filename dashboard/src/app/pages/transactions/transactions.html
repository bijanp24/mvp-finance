<div class="transactions-container">
  <div class="transactions-layout">
    <!-- Quick Add Form -->
    <mat-card class="quick-add-card">
      <mat-card-header>
        <mat-card-title>{{ editingEventId() ? 'Edit Transaction' : 'Quick Add Transaction' }}</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()">
          <!-- Transaction Type Toggle -->
          <mat-button-toggle-group formControlName="type" class="type-toggle">
            @for (type of eventTypes; track type.value) {
              <mat-button-toggle [value]="type.value">
                <mat-icon>{{ type.icon }}</mat-icon>
                {{ type.label }}
              </mat-button-toggle>
            }
          </mat-button-toggle-group>

          <!-- Amount -->
          <mat-form-field appearance="outline">
            <mat-label>Amount</mat-label>
            <input matInput type="number" formControlName="amount" placeholder="0.00" required>
            <span matTextPrefix>$&nbsp;</span>
            @if (transactionForm.get('amount')?.hasError('required') && transactionForm.get('amount')?.touched) {
              <mat-error>Amount is required</mat-error>
            }
            @if (transactionForm.get('amount')?.hasError('min')) {
              <mat-error>Amount must be greater than 0</mat-error>
            }
          </mat-form-field>

          <!-- Date -->
          <mat-form-field appearance="outline">
            <mat-label>Date</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="date" required>
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <!-- Source Account (for Income, Expense, DebtPayment, etc.) -->
          @if (transactionForm.get('type')?.value === 'Income' ||
               transactionForm.get('type')?.value === 'Expense' ||
               transactionForm.get('type')?.value === 'DebtPayment' ||
               transactionForm.get('type')?.value === 'SavingsContribution' ||
               transactionForm.get('type')?.value === 'InvestmentContribution') {
            <mat-form-field appearance="outline">
              <mat-label>From Account</mat-label>
              <mat-select formControlName="accountId" required>
                @for (account of cashAccounts(); track account.id) {
                  <mat-option [value]="account.id">{{ account.name }}</mat-option>
                }
              </mat-select>
              @if (transactionForm.get('accountId')?.hasError('required') && transactionForm.get('accountId')?.touched) {
                <mat-error>Account is required</mat-error>
              }
            </mat-form-field>
          }

          <!-- Target Account (for payments, contributions, charges) -->
          @if (showTargetAccount()) {
            <mat-form-field appearance="outline">
              <mat-label>To Account</mat-label>
              <mat-select formControlName="targetAccountId" required>
                @for (account of filteredTargetAccounts(); track account.id) {
                  <mat-option [value]="account.id">{{ account.name }}</mat-option>
                }
              </mat-select>
              @if (transactionForm.get('targetAccountId')?.hasError('required') && transactionForm.get('targetAccountId')?.touched) {
                <mat-error>Target account is required</mat-error>
              }
            </mat-form-field>
          }

          <!-- Debt Account (for charges) -->
          @if (transactionForm.get('type')?.value === 'DebtCharge') {
            <mat-form-field appearance="outline">
              <mat-label>Debt Account</mat-label>
              <mat-select formControlName="targetAccountId" required>
                @for (account of accounts(); track account.id) {
                  @if (account.type === 'Debt') {
                    <mat-option [value]="account.id">{{ account.name }}</mat-option>
                  }
                }
              </mat-select>
              @if (transactionForm.get('targetAccountId')?.hasError('required') && transactionForm.get('targetAccountId')?.touched) {
                <mat-error>Debt account is required</mat-error>
              }
            </mat-form-field>
          }

          <!-- Description -->
          <mat-form-field appearance="outline">
            <mat-label>Description</mat-label>
            <input matInput formControlName="description" placeholder="e.g., Grocery shopping">
          </mat-form-field>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="resetForm()">
              {{ editingEventId() ? 'Cancel' : 'Clear' }}
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="!transactionForm.valid || saving()">
              @if (saving()) {
                {{ editingEventId() ? 'Updating...' : 'Saving...' }}
              } @else {
                {{ editingEventId() ? 'Update Transaction' : 'Save Transaction' }}
              }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Recent Transactions -->
    <mat-card class="recent-transactions-card">
      <mat-card-header>
        <mat-card-title>Recent Transactions</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        @if (loading()) {
          <p>Loading transactions...</p>
        } @else if (recentEvents().length === 0) {
          <div class="empty-state">
            <mat-icon>receipt_long</mat-icon>
            <p>No transactions yet. Add your first transaction above!</p>
          </div>
        } @else {
          <div class="table-container">
            <table mat-table [dataSource]="recentEvents()" class="transactions-table">
              <!-- Date Column -->
              <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let event">{{ formatDisplayDate(event.date) }}</td>
              </ng-container>

              <!-- Type Column -->
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let event">
                  <mat-chip [highlighted]="true" [color]="getEventTypeColor(event.type)">
                    {{ event.type }}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Description Column -->
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef>Description</th>
                <td mat-cell *matCellDef="let event">{{ event.description || '-' }}</td>
              </ng-container>

              <!-- Account Column -->
              <ng-container matColumnDef="account">
                <th mat-header-cell *matHeaderCellDef>Account</th>
                <td mat-cell *matCellDef="let event">
                  {{ getAccountName(event.accountId) }}
                  @if (event.targetAccountId) {
                    <span> â†’ {{ getAccountName(event.targetAccountId) }}</span>
                  }
                </td>
              </ng-container>

              <!-- Amount Column -->
              <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef>Amount</th>
                <td mat-cell *matCellDef="let event" [class.positive]="event.type === 'Income'" [class.negative]="event.type === 'Expense'">
                  {{ formatCurrency(event.amount) }}
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let event">
                  <button mat-icon-button (click)="editEvent(event)" aria-label="Edit transaction">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button (click)="deleteEvent(event)" aria-label="Delete transaction">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>
        }
      </mat-card-content>
    </mat-card>
  </div>
</div>
